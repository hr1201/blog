# toç³»åˆ—


## toRef

ç”¨äºä¿®æ”¹å“åº”å¼å¯¹è±¡çš„å€¼ï¼Œä½†æ˜¯å¯¹éå“åº”å¼å¯¹è±¡ä½œä¿®æ”¹å…¶è§†å›¾ä¸ä¼šè·Ÿç€å˜åŒ–ã€‚æ‰€ä»¥å¹¶æ²¡ä»€ä¹ˆç”¨ï¼Œä¸è¿‡ä¸ºæ¥ä¸‹æ¥ä½¿ç”¨toRefså¯ä»¥èµ·åˆ°ç†è§£ä½œç”¨ã€‚



toRefä¼šæä¾›ä¸€ä¸ªè®¿é—®å“åº”å¼å¯¹è±¡çš„å±æ€§çš„refï¼Œä½¿å¾—åœ¨propçš„refä¼ é€’æˆ–è€…å¤åˆå¯¹è±¡è§£æ„æ—¶å¯ä»¥ä¿æŒå“åº”å¼ã€‚



ç¤ºä¾‹ä»£ç ï¼š

```Vue
<template>
    <div>
        {{ rarrot }}
    </div>
    <hr>
    <div>
        {{ rarrot2 }}
    </div>
    <button @click="edit">ä¿®æ”¹</button>
</template>

<script setup lang='ts'>
import { toRef, reactive } from 'vue'

// toRef åªèƒ½ä¿®æ”¹å“åº”å¼å¯¹è±¡çš„å€¼ Â 
const rarrot = reactive({ name: 'rarrot', age: 66 })
const name = toRef(rarrot, 'name')

// toRef ä¿®æ”¹éå“åº”å¼å¯¹è±¡å…¶è§†å›¾ä¸ä¼šå˜åŒ–
const rarrot2 = { name: 'rarrot2', age: 99 }
const name2 = toRef(rarrot2, 'name')

const edit = () => {
    name.value = 'nihao'
    console.log("ğŸš€  rarrot", rarrot)
    name2.value='nihao2'
    console.log("ğŸš€  rarrot2", rarrot2)
}

</script>
<style scoped></style> 
```

![](https://cdn.jsdelivr.net/gh/hr1201/img@main/imgs/202308051717921.png)

<br>


## toRefs

toRefså¯ä»¥ç”¨äºå¯¹è±¡è§£æ„ï¼Œç”±äºå“åº”å¼å¯¹è±¡è§£æ„ä¹‹åçš„å±æ€§æ˜¯ä¸å…·æœ‰å“åº”å¼çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åˆ°toRefè¿›è¡Œä¿æŒå“åº”å¼ã€‚



ä½¿ç”¨æ–¹å¼çš„ç¤ºä¾‹ä»£ç ï¼š

```Vue
<template>
    <div>
        {{ rarrot }}
    </div>
    <hr>
    <div>
        {{ name }}---{{ age }}
    </div>
    <button @click="edit">ä¿®æ”¹</button>
</template>

<script setup lang='ts'>
import { reactive,toRefs } from 'vue'

const rarrot = reactive({ name: 'rarrot', age: 66 })

let { name, age } = toRefs(rarrot)

// åƒä»¥ä¸‹è¿™ç§ç›´æ¥è§£æ„è§†å›¾æ˜¯ä¸ä¼šå˜åŒ–çš„
// let {name,age}=rarrot

const edit = () => {
    name.value = 'nihao'
    console.log("ğŸš€  rarrot", rarrot)
}

</script>
<style scoped></style> 
```

![](https://cdn.jsdelivr.net/gh/hr1201/img@main/imgs/202308051747148.png)


<br>
  


ç®€æ˜“çš„å®ç°toRefsï¼Œçœ‹ä»¥ä¸‹ç¤ºä¾‹ä»£ç ï¼š

```Vue
<template>
    <div>
        {{ rarrot }}
    </div>
    <hr>
    <div>
        {{ name }}---{{ age }}
    </div>
    <button @click="edit">ä¿®æ”¹</button>
</template>

<script setup lang='ts'>
import { toRef, reactive, toRaw } from 'vue'

const rarrot = reactive({ name: 'rarrot', age: 66 })

const toRefs = <T extends object>(object: T) => {
    const map: any = {}
    for (let key in object) {
        // const name=toRef(rarrot,'name')å…¶å®ä¸‹é¢è¿™è¡Œè·Ÿè¿™ä¸€è¡Œä¸€æ ·ï¼Œå¯¹æ¯”ç€æ¥çœ‹
  // çœŸæ­£çš„æºç é‡Œé¢æ˜¯è°ƒç”¨çš„propertyToRefæ–¹æ³•ï¼Œç„¶ååœ¨è°ƒç”¨çš„ObjectRefImplæ–¹æ³•


        map[key] = toRef(object, key)
    }
    return map
}

// é€‚ç”¨äºè§£æ„èµ‹å€¼ï¼Œtorefså°±æ˜¯æŒ‰ç…§ä¼ å…¥å‚æ•°ä¸€æ¬¡æ€§è§£æ„å¤šä¸ª
let { name, age } = toRefs(rarrot)

const edit = () => {
    console.log("åˆå§‹çš„ğŸš€  rarrot", rarrot);

    name.value = 'nihao'
    age.value = 33
    // ä»¥ä¸‹è¿™ç§æ–¹å¼ä¹Ÿå¯ä»¥ä½¿å¾—è§†å›¾å˜åŒ–
    // rarrot.name='nihao'
    // rarrot.age=33
    console.log("ğŸš€  rarrot", rarrot)

}

</script>
<style scoped></style> 
```

![](https://cdn.jsdelivr.net/gh/hr1201/img@main/imgs/202308051754019.png)


<br>



## toRaw

`toRaw()`å¯ä»¥ä»[reactive()](https://cn.vuejs.org/api/reactivity-core.html#reactive),Â [readonly()](https://cn.vuejs.org/api/reactivity-core.html#readonly),Â [shallowReactive()](https://cn.vuejs.org/api/reactivity-advanced.html#shallowreactive)æˆ–Â [shallowReadonly()](https://cn.vuejs.org/api/reactivity-advanced.html#shallowreadonly).åˆ›å»ºçš„proxyè¿”å›åŸå§‹å¯¹è±¡ã€‚

<br>


å…·æœ‰ä¸¤ä¸ªä½¿ç”¨åœºæ™¯ï¼š

1. åœ¨å‰é¢çš„refæºç ä¸­ï¼Œå°±æœ‰å°†refå“åº”å¼å¯¹è±¡è½¬æ¢ä¸ºåŸå§‹å¯¹è±¡è¿›è¡Œæ¯”è¾ƒï¼Œç„¶åè§‚å¯Ÿå±æ€§å€¼æˆ–å¼•ç”¨æ˜¯å¦æœ‰æ”¹å˜ï¼Œæœ‰æ”¹å˜çš„è¯ï¼Œå°±è¿›è¡Œä¾èµ–çš„æ›´æ–°ã€‚
2. æœ‰äº›æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦ä¸´æ—¶è·å¾—åŸå§‹å¯¹è±¡çš„å€¼,å¹¶ä¸å¸Œæœ›å¼•èµ·ä»£ç†å¯¹è±¡æ›´æ”¹çš„å‰¯ä½œç”¨ã€‚æ¯”å¦‚è¯´æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ã€ Cookies ç­‰,å®ƒä»¬ä¸èƒ½å­˜å‚¨ Proxy å¯¹è±¡,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `toRaw()` æ¥è·å–æºå¯¹è±¡å¹¶å­˜å‚¨ã€‚

<br>


çœ‹ç¤ºä¾‹ï¼š

```Vue
<template>
    <div>
        {{ rarrot }}
    </div>
    <hr>

    <button @click="edit">ä¿®æ”¹</button>
</template>

<script setup lang='ts'>
import { reactive, toRaw } from 'vue'

const rarrot = reactive({ name: 'rarrot', age: 66 })

const edit = () => {
    console.log(rarrot,toRaw(rarrot));
 Â  Â // toRawå…¶å®æ˜¯è·Ÿä»¥ä¸‹ä»£ç ä¸€æ ·çš„,åœ¨æºç ä¸­ä¹Ÿæ˜¯è¿™æ ·åšçš„
Â  Â  console.log(rarrot,rarrot['__v_raw']);
}

</script>
<style scoped></style> 
```

![](https://cdn.jsdelivr.net/gh/hr1201/img@main/imgs/202308051822552.png)


<br>



## æºç è§£æ

### toRef

```typescript
/**
 * Used to normalize values / refs / getters into refs.
 * ç”¨äºå°†å€¼/å¼•ç”¨/è·å–å™¨è§„èŒƒåŒ–ä¸ºå¼•ç”¨ã€‚
 *
 * @example
 * 
 * // returns existing refs as-is
 * toRef(existingRef)
 *
 * // creates a ref that calls the getter on .value access
 * toRef(() => props.foo)
 *
 * // creates normal refs from non-function values
 * // equivalent to ref(1)
 * toRef(1)
 * 
 *
 * è¿˜å¯ç”¨äºä¸ºæºååº”å¯¹è±¡ä¸Šçš„å±æ€§åˆ›å»ºå¼•ç”¨ã€‚
 * åˆ›å»ºçš„å¼•ç”¨ä¸å…¶æºå±æ€§åŒæ­¥ï¼šæ”¹å˜æº
 * å±æ€§å°†æ›´æ–°å¼•ç”¨ï¼Œåä¹‹äº¦ç„¶ã€‚
 * 
 * @example
 * å‰é¢ç»™å‡ºäº†ç¤ºä¾‹
 *
 * @param source - A getter, an existing ref, a non-function value, or a
 *                 reactive object to create a property ref from.
 * @param [key] - (optional) Name of the property in the reactive object.
 * @see {@link https://vuejs.org/api/reactivity-utilities.html#toref}
 */
// å½“åªä¼ ä¸€ä¸ªå‚æ•°valueæ—¶ï¼Œè‹¥å‚æ•°ä¸ºæ™®é€šå€¼ï¼Œè¿”å›åŒ…å«è¿™ä¸ªå€¼çš„Refï¼›è‹¥å·²ç»æ˜¯Refï¼Œè¿”å›è‡ªèº«
export function toRef<T>(
  value: T
): T extends () => infer R
  ? Readonly<Ref<R>>
  : T extends Ref
  ? T
  : Ref<UnwrapRef<T>>

// ä¼ ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå¼•ç”¨ç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå¯¹è±¡çš„é”®åï¼Œä¹Ÿæ˜¯å±æ€§å
// è¿”å›ToRefç±»å‹ï¼ŒåŒ…å«æŒ‡å®šå¯¹è±¡åŸå±æ€§çš„Ref
export function toRef<T extends object, K extends keyof T>(
  object: T,
  key: K
): ToRef<T[K]>

// ä¼ ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºé»˜è®¤å€¼ï¼Œè¿”å›åŒ…å«é»˜è®¤å€¼çš„ToRef
export function toRef<T extends object, K extends keyof T>(
  object: T,
  key: K,
  defaultValue: T[K]
): ToRef<Exclude<T[K], undefined>>

// ä»¥ä¸‹å‡½æ•°ä¸ºå®ç°ä»£ç ï¼Œä¼šæ ¹æ®å‚æ•°ä¸åŒè¿”å›ä¸åŒç»“æœï¼Œä¸»è¦ç”¨äºå°†å¯¹è±¡çš„å±æ€§è½¬æ¢ä¸ºrefå¯¹è±¡
export function toRef(
  source: Record<string, any> | MaybeRef,
  key?: string,
  defaultValue?: unknown
): Ref {
  // åˆ¤æ–­æ˜¯å¦ä¸ºRefï¼Œæ˜¯å°±ç›´æ¥è¿”å›æºrefå¯¹è±¡


  if (isRef(source)) {
    return source
  } else if (isFunction(source)) {
  // åˆ¤æ–­æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±ç”¨GetterRefImplç±»åˆ›å»ºä¸€ä¸ªrefå¯¹è±¡è¿”å›

  // è¿™ä¸ªç±»å®ç°äº†ä¸€ä¸ªå¯ä»¥æƒ°æ€§è·å–å€¼çš„ref


    return new GetterRefImpl(source) as any
  } else if (isObject(source) && arguments.length > 1) {
  // åˆ¤æ–­æ˜¯å¦ä¸ºå¼•ç”¨ç±»å‹ï¼Œæ˜¯å°±è°ƒç”¨ä»¥ä¸‹å‡½æ•°


    return propertyToRef(source, key!, defaultValue)
  } else {
    return ref(source)
  }
}
```

ä»¥ä¸Šä»£ç ä¸­ä¼šå»è°ƒç”¨`propertyToRef(source, key!, defaultValue)`ã€‚

<br>


`GetterRefImpl(source)`å’Œ`ToRef`ç±»å‹çš„æºä»£ç å¦‚ä¸‹ï¼š

```typescript
class GetterRefImpl<T> {
Â  public readonly __v_isRef = true
Â  public readonly __v_isReadonly = true
Â  constructor(private readonly _getter: () => T) { }
Â  get value() {
Â  Â  return this._getter()
Â  }
}

export type ToRef<T> = IfAny<T, Ref<T>, [T] extends [Ref] ? T : Ref<T>>
```

<br>


`propertyToRef(source, key!, defaultValue)`çš„æºä»£ç å¦‚ä¸‹ï¼š

```typescript
function propertyToRef(
Â  source: Record<string, any>,
Â  key: string,
Â  defaultValue?: unknown
) {
Â  const val = source[key]
Â  return isRef(val)
Â  Â  ? val
Â  Â  : (new ObjectRefImpl(source, key, defaultValue) as any)
}
```

ä»¥ä¸Šä»£ç å…ˆä»æºå¯¹è±¡sourceä¸­è·å–keyå±æ€§çš„å€¼valï¼Œç”¨valè¿›è¡Œåˆ¤æ–­æ˜¯å¦ä¸ºrefå¯¹è±¡ï¼Œä¸æ˜¯å°±è°ƒç”¨`ObjectRefImpl(source, key, defaultValue)`ã€‚


<br>


`ObjectRefImpl(source, key, defaultValue)`çš„æºä»£ç å¦‚ä¸‹ï¼š

```typescript
class ObjectRefImpl<T extends object, K extends keyof T> {
  public readonly __v_isRef = true

   constructor(
    private readonly _object: T,
    private readonly _key: K,
    private readonly _defaultValue?: T[K]
  ) { }

  get value() {
    const val = this._object[this._key]
    return val === undefined ? this._defaultValue! : val
  }

  set value(newVal) {
    this._object[this._key] = newVal
  }

  get dep(): Dep | undefined {
    return getDepFromReactive(toRaw(this._object), this._key)
  }
}
```

ä»¥ä¸‹å‡½æ•°ç±»ä¼¼äºrefä¸­çš„`RefImpl()`ï¼Œåªä¸è¿‡RefImplé‡Œé¢è¿›è¡Œäº†æ”¶é›†ä¾èµ–å’Œæ›´æ–°ä¾èµ–ï¼Œè€Œè¿™é‡Œæ²¡æœ‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ™®é€šå¯¹è±¡ä¸ä¼šæœ‰è§†å›¾çš„å˜åŒ–ï¼Œå“åº”å¼å¯¹è±¡ä½¿ç”¨reactiveï¼Œreactiveé‡Œé¢è¯­å¥ä¼šè¿›è¡Œæ”¶é›†ä¾èµ–å’Œæ›´æ–°ä¾èµ–çš„æ“ä½œã€‚è€Œè¿™é‡Œå®ç°äº†ä¸€ä¸ªå¯ä»¥è·Ÿè¸ªæºå¯¹è±¡å±æ€§å˜åŒ–çš„refï¼Œå¹¶ä¸”ä¹Ÿæœ‰getå’Œsetå®ç°å“åº”å¼ã€‚

<br>




### toRefs

è·Ÿå‰é¢ç®€æ˜“å†™ä¸€ä¸ªtoRefsåšçš„æ“ä½œæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä¼šå…ˆè°ƒç”¨`propertyToRef(object, key)`åˆ¤æ–­å¯¹è±¡çš„æ¯ä¸ªå±æ€§æ˜¯å¦ä¸ºrefå¯¹è±¡ã€‚å†è·Ÿä¸Šé¢toRefä¸€æ ·çš„æµç¨‹ï¼Œåªä¸è¿‡è¿™é‡Œå¯¹æ¯ä¸ªè§£æ„çš„å±æ€§éƒ½è¿›è¡Œäº†ä¸€éã€‚

```typescript
/**
Â *
Â * å°†å“åº”å¼å¯¹è±¡ä¸­æ¯ä¸ªå±æ€§éƒ½è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è§£æ„
Â * ç»“æœå¯¹è±¡æ˜¯ä¸€ä¸ªæŒ‡å‘ç›¸åº”å±æ€§çš„å¼•ç”¨
Â * åŸå§‹å¯¹è±¡ã€‚æ¯ä¸ªå•ç‹¬çš„å¼•ç”¨éƒ½æ˜¯ä½¿ç”¨ {@link toRef()} åˆ›å»ºçš„ã€‚
Â *
Â * @param object - Reactive object to be made into an object of linked refs.
Â * @see {@link https://vuejs.org/api/reactivity-utilities.html#torefs}
Â */
export function toRefs<T extends object>(object: T): ToRefs<T> {
Â  if (__DEV__ && !isProxy(object)) {
Â  Â  console.warn(`toRefs() expects a reactive object but received a plain one.`)
Â  }
Â  const ret: any = isArray(object) ? new Array(object.length) : {}
Â  for (const key in object) {
Â  Â  ret[key] = propertyToRef(object, key)
Â  }
Â  return ret
}
```

<br>



### toRaw
 
ç”¨äºè½¬æ¢ä¸ºåŸå§‹å¯¹è±¡ï¼Œå®é™…å°±æ˜¯é€šè¿‡å°†åŸå§‹å¯¹è±¡å­˜å…¥åˆ°proxyä¸­ï¼Œä½¿ç”¨`ReactiveFlags.RAW`çš„\_\_v\_rawå‚æ•°å¯å–å‡ºåŸå§‹å‚æ•°ã€‚

```typescript
/**
Â * Returns the raw, original object of a Vue-created proxy.
Â *
Â * `toRaw()` can return the original object from proxies created by
Â * {@link reactive()}, {@link readonly()}, {@link shallowReactive()} or
Â * {@link shallowReadonly()}.
Â *
Â * This is an escape hatch that can be used to temporarily read without
Â * incurring proxy access / tracking overhead or write without triggering
Â * changes. It is **not** recommended to hold a persistent reference to the
Â * original object. Use with caution.
Â *
Â * @example
Â * 
Â * const foo = {}
Â * const reactiveFoo = reactive(foo)
Â *
Â * console.log(toRaw(reactiveFoo) === foo) // true
Â * 
Â *
Â * @param observed - The object for which the "raw" value is requested.
Â * @see {@link https://vuejs.org/api/reactivity-advanced.html#toraw}
Â */
export function toRaw<T>(observed: T): T {
Â  const raw = observed && (observed as Target)[ReactiveFlags.RAW]
Â  return raw ? toRaw(raw) : observed
}
```

<br>


```typescript
export const enum ReactiveFlags {
Â  SKIP = '__v_skip',
Â  IS_REACTIVE = '__v_isReactive',
Â  IS_READONLY = '__v_isReadonly',
Â  IS_SHALLOW = '__v_isShallow',
Â  RAW = '__v_raw'
}
```

